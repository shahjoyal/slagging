<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Abhitech Energycon Limited</title>
    <link rel="icon" href="images/abhitech-logo.png">

    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-size: large;
            font-family: Arial, sans-serif; 
        }

        
        .navbar {
            display: flex;
            justify-content: space-between;
            width: 100%;
            background-color: #f7f8fa;
            align-items: center;
            padding: 15px 20px;
            color: white;
            position: fixed;
            top: 0;
            left: 0;
            height: 65px;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .navbar img {
            height: 95px;
            margin-right: 10px;
            margin-left: 0px;
        }
        .nav-buttons {
            display: flex;
            gap: 10px;
            margin-right: 20px;
        }
        .navbar button {
            padding: 10px 15px;
            background-color: #02008a;
            color: #ffffff;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            margin-right: 20px;
            font-weight: bold;
        }
        .navbar button:hover {
            background-color: #001cbb;
        }
        .navbar h1 {
            margin-left: 0px;
            font-size: 20px;
            color: black;
        }

       
        .toolbar-wrapper {
            margin-top: 60px;
            width: 100%;
            display: flex;
            justify-content: center;
        }

        .toolbar {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            max-width: 900px;
        }

        
        button {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 3px 8px rgba(0,0,0,0.12);
            white-space: nowrap;
        }
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 12px rgba(0,0,0,0.18);
        }

       
        .btn-template {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: #fff;
        }

        .btn-upload {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: #fff;
        }
        #fileInput { display: none; }

       
        #delete-selected-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: #fff;
        }

        
        .download-dropdown .menu-btn {
            background: linear-gradient(135deg,#0ea5e9,#0284c7);
            color: white;
        }

        
        #downloadPDF {
            background: #02008a;
            border-radius: 50%;
            padding: 10px 12px;
            color: #fff;
        }

      
        .navbar .logout-btn {
            padding: 10px 16px;
            background-color: red !important;
            color: #fff !important;
            border: none;
            cursor: pointer;
            border-radius: 25px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .navbar .logout-btn:hover {
            background-color: darkred !important;
        }

       
        .download-dropdown {
            position: relative;
            display: inline-block;
        }

        
        .download-dropdown .dropdown-menu {
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            display: none;
            background: white;
            min-width: 170px;
            border-radius: 8px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.16);
            z-index: 2000;
            padding: 6px;
        }

        .download-dropdown .dropdown-menu button {
            display: block;
            width: 100%;
            text-align: left;
            padding: 8px 10px;
            background: transparent;
            border-radius: 6px;
            margin: 0;
            box-shadow: none;
        }

        .download-dropdown .dropdown-menu button:hover {
            background: #f3f4f6;
            transform: none;
        }

      
        .table-wrapper {
            margin-top: 20px;
            padding: 0 16px 32px;
            overflow-x: auto;    
            background: linear-gradient(180deg, rgba(2,0,138,0.02), transparent 40%);
            border-radius: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px; /* keeps layout but allows responsiveness */
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; /* nicer on table only */
            font-size: 13px;
            color: #1f2937;
            background: white;
            box-shadow: 0 4px 18px rgba(2,6,23,0.04);
            border-radius: 8px;
            overflow: hidden;
        }

        thead th {
            background-color: #02008a; /* requested header color */
            color: #ffffff;
            padding: 12px 14px;
            text-align: center;
            font-weight: 700;
            letter-spacing: 0.2px;
            white-space: nowrap; /* avoid header wrap */
            border-bottom: 2px solid rgba(0,0,0,0.06);
        }

        tbody td {
            border-bottom: 1px solid #eef2f7;
            padding: 10px 12px;
            text-align: center;
        }

        tbody tr:nth-child(even) {
            background: #fbfdff;
        }

        tbody tr:hover {
            background: #f1f5f9;
            transform: translateY(0);
            transition: background 0.12s ease;
        }

        /* Keep first column sticky for easy reference (kept from original) */
       td:first-child {
            position: sticky;
            left: 0;
            background-color: white;
            z-index: 2;
            box-shadow: 2px 0 6px rgba(0,0,0,0.04);
            font-weight: 600;
        }

        /* Make checkboxes column a little narrower */
        tbody td:last-child, thead th:last-child {
            width: 86px;
            min-width: 86px;
            max-width: 130px;
        }

        /* Responsive tweaks: reduce font slightly on small screens */
        @media (max-width: 900px) {
            table { font-size: 12px; min-width: 760px; }
            thead th { padding: 10px 8px; }
            tbody td { padding: 8px 8px; }
        }

        /* Upload new data styling (kept) */
        .btn-upload {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: #ffffff;
            box-shadow: 0 3px 8px rgba(0,0,0,0.12);
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .btn-upload:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 12px rgba(0,0,0,0.18);
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
        }

        #fileInput {
            display: none;
        }
        /* -------------------- END ENHANCED TABLE UI -------------------- */
    </style>

    <script>
        // Simple auth check (kept as original)
        if (localStorage.getItem('isLoggedIn') !== 'true') {
            alert('You must login first!');
            window.location.href = '/login.html';
        } else {
            document.body.style.display = 'block';
        }
        function logoutUser() {
            localStorage.setItem('isLoggedIn', 'false');
            window.location.href = 'login.html';
        }
    </script>
</head>
<body>
    <div class="navbar">
        <img src="/images/abhitech-logo.png" alt="Company Logo">
        <h1>Combustion Analyzer</h1>
        <div class="nav-buttons">
            <button onclick="window.location.href='model.html'">Model</button>
            <button onclick="window.location.href='slagging_coal_page.html'">Calculation</button>
            <!-- <button onclick="window.location.href='coal_blend_simulation.html'">Coal Blend Simulation</button> -->
            <button class="logout-btn" onclick="logoutUser()">Logout</button>
        </div>
    </div>

    <h1 style="margin-top:100px; text-align:center;">Slagging Data Table</h1>

    <!-- CENTERED TOOLBAR -->
    <div class="toolbar-wrapper">
        <div class="toolbar">
            <button class="btn-template" onclick="downloadExcel()">Download Template</button>

            <label for="fileInput" class="btn-upload">üì§ Upload New Data</label>
            <input type="file" id="fileInput" accept=".xlsx, .xls">

            <button id="delete-selected-btn">Delete Selected</button>

            <div class="download-dropdown">
                <button id="download-selected-btn" class="menu-btn">
                    Download Selected ‚ñæ
                </button>
                <div id="download-menu" class="dropdown-menu" aria-hidden="true">
                    <button type="button" onclick="downloadSelected('excel')">Download as Excel</button>
                    <button type="button" onclick="downloadSelected('pdf')">Download as PDF</button>
                </div>
            </div>

            <button id="downloadPDF" title="Download full page as PDF">‚¨áÔ∏è</button>
        </div>
    </div>

    <div class="table-wrapper">
        <table id="data-table">
            <thead>
                <tr id="table-header"></tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>

    <script>
        /* ---------- GLOBALS ---------- */
        let pdfLogoDataUrl = null;
        const { jsPDF } = window.jspdf;

        function downloadExcel() {
            window.location.href = "/download-template";
        }

        /* ---------- UTIL: Format values to two decimals when numeric ---------- */
        function formatCellValue(value) {
            if (value === null || value === undefined) return "";
            // If value is a number -> format
            if (typeof value === "number" && isFinite(value)) {
                return value.toFixed(2);
            }
            // If string that represents a number -> format
            if (typeof value === "string") {
                const trimmed = value.trim();
                if (trimmed === "") return "";
                // Disallow formatting strings that are clearly not numeric (e.g., contain letters)
                // But Number("123.45") works, Date-like "2025-12-10" -> NaN, so safe
                const num = Number(trimmed);
                if (!isNaN(num) && isFinite(num)) {
                    return num.toFixed(2);
                }
                return value;
            }
            // Objects/arrays -> json
            if (typeof value === "object") {
                try { return JSON.stringify(value); } catch(e) { return String(value); }
            }
            // fallback
            return String(value);
        }

        /* ---------- LOAD DATA & TABLE ---------- */
        function fetchData() {
            fetch("/fetch-data")
                .then(response => response.json())
                .then(data => displayTable(data))
                .catch(error => console.error("Error fetching data:", error));
        }

        document.getElementById("fileInput").addEventListener("change", function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append("file", file);

            fetch("/upload-excel", {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                alert("File uploaded successfully!");
                window.location.reload();
                displayTable(data);
            })
            .catch(error => console.error("Error uploading file:", error));
        });

        function displayTable(data) {
            const tableHeader = document.getElementById("table-header");
            const tableBody = document.getElementById("table-body");
            tableHeader.innerHTML = "";
            tableBody.innerHTML = "";

            if (!data || data.length === 0) return;

            // create headers (exclude _id)
            const headers = Object.keys(data[0]).filter(h => h !== "_id");
            const displayHeaders = headers.concat(["Select"]);

            // headers
            displayHeaders.forEach((header) => {
                let th = document.createElement("th");
                th.textContent = header;
                tableHeader.appendChild(th);
            });

            // rows
            data.forEach(row => {
                let tr = document.createElement("tr");

                headers.forEach(header => {
                    let td = document.createElement("td");
                    const raw = row[header] !== undefined ? row[header] : "";
                    td.textContent = formatCellValue(raw);
                    tr.appendChild(td);
                });

                // checkbox
                let checkboxTd = document.createElement("td");
                let checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.setAttribute("data-id", row._id || "");
                try {
                    // store original row for downloads; still store original numeric values
                    checkbox.dataset.row = JSON.stringify(row);
                } catch (e) {
                    checkbox.dataset.row = "{}";
                }
                checkboxTd.appendChild(checkbox);
                tr.appendChild(checkboxTd);

                tableBody.appendChild(tr);
            });
        }

        /* ---------- DELETE SELECTED ---------- */
        document.getElementById("delete-selected-btn").addEventListener("click", function() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                alert("Please select at least one row to delete.");
                return;
            }

            if (!confirm("Are you sure you want to delete the selected data?")) return;

            const ids = Array.from(checkboxes).map(checkbox => checkbox.getAttribute("data-id"));

            fetch("/delete-data", {
                method: "DELETE",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ ids: ids })
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                fetchData();
            })
            .catch(error => console.error("Error deleting data:", error));
        });

        /* ---------- LOGO FOR PDF HEADER ---------- */
        function loadPdfLogo() {
            const img = new Image();
            img.src = "/images/abhitech-logo.png";
            img.crossOrigin = "anonymous";

            img.onload = function () {
                const canvas = document.createElement("canvas");
                const targetWidth = 200;
                const ratio = img.width ? targetWidth / img.width : 1;
                canvas.width = targetWidth;
                canvas.height = img.height * ratio;

                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                pdfLogoDataUrl = canvas.toDataURL("image/png");
            };

            img.onerror = function () {
                console.warn("Could not load logo for PDF header");
                pdfLogoDataUrl = null;
            };
        }

        /* ---------- DROPDOWN TOGGLE (NOW SAFE) ---------- */
        function setupDownloadDropdown() {
            const downloadBtn = document.getElementById("download-selected-btn");
            const downloadMenu = document.getElementById("download-menu");

            if (!downloadBtn || !downloadMenu) return;  // prevents null.style errors

            downloadBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                const visible = downloadMenu.style.display === "block";
                downloadMenu.style.display = visible ? "none" : "block";
                downloadMenu.setAttribute("aria-hidden", visible ? "true" : "false");
            });

            document.addEventListener("click", (e) => {
                if (!downloadMenu.contains(e.target) && e.target !== downloadBtn) {
                    downloadMenu.style.display = "none";
                    downloadMenu.setAttribute("aria-hidden", "true");
                }
            });
        }

        /* ---------- DOWNLOAD SELECTED (EXCEL / PDF) with formatted numbers ---------- */
        async function downloadSelected(format) {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                alert("Please select at least one row to download.");
                return;
            }

            const rows = Array.from(checkboxes).map(cb => {
                try {
                    return JSON.parse(cb.dataset.row || "{}");
                } catch (e) {
                    return {};
                }
            });

            const downloadMenu = document.getElementById("download-menu");
            if (downloadMenu) downloadMenu.style.display = "none";

            // keys without _id
            const keys = Object.keys(rows[0] || {}).filter(k => k !== "_id");

            if (format === 'excel') {
                const jsonData = rows.map(r => {
                    const obj = {};
                    keys.forEach(k => {
                        // use formatted representation for excel output (string of numeric with 2 decimals)
                        const raw = r[k] !== undefined ? r[k] : "";
                        obj[k] = formatCellValue(raw);
                    });
                    return obj;
                });
                const ws = XLSX.utils.json_to_sheet(jsonData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Selected");
                XLSX.writeFile(wb, "selected_rows.xlsx");
            } else if (format === 'pdf') {
                const doc = new jsPDF("l", "mm", "a4"); // landscape
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();

                const marginX = 10;
                const marginY = 22; // below the "navbar"
                const lineHeight = 4;
                const usableWidth = pageWidth - 2 * marginX;
                const colWidth = usableWidth / keys.length;

                doc.setFontSize(8);
                doc.setFont(undefined, "normal");

                // --- HEADER WITH LOGO + TITLE ---
                function drawPdfHeader() {
                    doc.setFillColor(2, 0, 138);
                    doc.rect(0, 0, pageWidth, 15, "F");

                    let logoRightX = 5;
                    if (pdfLogoDataUrl) {
                        const logoW = 18;
                        const logoH = 9;
                        doc.addImage(pdfLogoDataUrl, "PNG", 3, 3, logoW, logoH);
                        logoRightX = 3 + logoW;
                    }

                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(12);
                    doc.setFont(undefined, "bold");
                    doc.text("Combustion Analyzer", logoRightX + 4, 10);

                    doc.setFontSize(10);
                    doc.text("Slagging Data Table - Selected Rows", pageWidth / 2, 10, { align: "center" });

                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(8);
                    doc.setFont(undefined, "normal");
                }

                let y = marginY;

                function drawHeaderRow() {
                    doc.setFont(undefined, "bold");
                    keys.forEach((h, index) => {
                        const x = marginX + index * colWidth;
                        const headerLines = doc.splitTextToSize(String(h), colWidth - 2);
                        let lineY = y;
                        headerLines.forEach(line => {
                            doc.text(line, x, lineY);
                            lineY += lineHeight;
                        });
                    });
                    doc.setFont(undefined, "normal");
                    y += lineHeight * 1.5;
                }

                function addNewPage() {
                    doc.addPage();
                    drawPdfHeader();
                    y = marginY;
                    drawHeaderRow();
                }

                drawPdfHeader();
                drawHeaderRow();

                rows.forEach((row) => {
                    const cellData = keys.map((k, index) => {
                        const raw = row[k] !== undefined && row[k] !== null ? row[k] : "";
                        const value = String(formatCellValue(raw)); // format numbers here too
                        const x = marginX + index * colWidth;
                        const lines = doc.splitTextToSize(value, colWidth - 2);
                        return { x, lines };
                    });

                    const maxLines = Math.max(...cellData.map(c => c.lines.length || 1));
                    const rowHeight = maxLines * lineHeight + 1;

                    if (y + rowHeight > pageHeight - 10) {
                        addNewPage();
                    }

                    cellData.forEach(cell => {
                        let lineY = y;
                        cell.lines.forEach(line => {
                            doc.text(line, cell.x, lineY);
                            lineY += lineHeight;
                        });
                    });

                    y += rowHeight;
                });

                doc.save("selected_rows.pdf");
            } else {
                alert("Unsupported download format: " + format);
            }
        }

        /* ---------- FULL PAGE PDF (WITH REAL NAVBAR) ---------- */
        document.getElementById("downloadPDF").addEventListener("click", function () {
            const element = document.body;

            window.scrollTo(0, 0);

            html2canvas(element, {
                scale: 2,
                useCORS: true,
                scrollY: -window.scrollY,
                onclone: (clonedDoc) => {
                    const inputs = clonedDoc.querySelectorAll("input, textarea");
                    inputs.forEach(input => {
                        const text = clonedDoc.createElement("span");
                        text.textContent = input.value;
                        text.style.position = "absolute";
                        text.style.left = input.offsetLeft + "px";
                        text.style.top = input.offsetTop + "px";
                        text.style.width = input.offsetWidth + "px";
                        text.style.height = input.offsetHeight + "px";
                        text.style.lineHeight = input.offsetHeight + "px";
                        text.style.textAlign = "center";
                        text.style.font = window.getComputedStyle(input).font;
                        text.style.color = window.getComputedStyle(input).color;
                        clonedDoc.body.appendChild(text);
                        input.style.visibility = "hidden";
                    });

                    const selects = clonedDoc.querySelectorAll("select");
                    selects.forEach(select => {
                        const selectedText = select.options[select.selectedIndex]?.text || "";
                        const text = clonedDoc.createElement("span");
                        text.textContent = selectedText;
                        text.style.position = "absolute";
                        text.style.left = select.offsetLeft + "px";
                        text.style.top = select.offsetTop + "px";
                        text.style.width = select.offsetWidth + "px";
                        text.style.height = select.offsetHeight + "px";
                        text.style.lineHeight = select.offsetHeight + "px";
                        text.style.textAlign = "center";
                        text.style.font = window.getComputedStyle(select).font;
                        text.style.color = window.getComputedStyle(select).color;
                        clonedDoc.body.appendChild(text);
                        select.style.visibility = "hidden";
                    });
                }
            }).then(canvas => {
                const pdf = new jsPDF("p", "mm", "a4");
                const imgData = canvas.toDataURL("image/png");

                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();

                const imgWidth = pageWidth;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;

                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                pdf.save("Coal_Blending_Ratio.pdf");
            });
        });

        /* ---------- INIT ON DOM READY ---------- */
        document.addEventListener("DOMContentLoaded", () => {
            loadPdfLogo();
            fetchData();
            setupDownloadDropdown();
        });
    </script>
</body>
</html>
